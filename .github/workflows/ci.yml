# Lumi Agent CI ì›Œí¬í”Œë¡œìš°
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì½”ë“œê°€ pushë˜ê±°ë‚˜ PRì´ ìƒì„±ë  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸, PR ì½”ë©˜íŠ¸, AI ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
#
# ì£¼ìš” Job:
#   1. lint: Ruffë¥¼ ì‚¬ìš©í•œ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
#   2. test: pytestë¥¼ ì‚¬ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (lint ì„±ê³µ ì‹œ ì‹¤í–‰)
#   3. comment: PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì½”ë©˜íŠ¸ (í•­ìƒ ì‹¤í–‰)
#   4. ai-review: AIê°€ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•˜ê³  PRì— ì½”ë©˜íŠ¸
#
# í•„ìš”í•œ GitHub Secrets:
#   - UPSTAGE_API_KEY: í…ŒìŠ¤íŠ¸ ë° AI ë¦¬ë·°ìš© LLM API í‚¤
#   - SUPABASE_URL: Supabase í”„ë¡œì íŠ¸ URL
#   - SUPABASE_KEY: Supabase API í‚¤
name: Lumi Agent CI

# TODO 1: íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸ ì„¤ì •. main ë¸Œëžœì¹˜ì— pushë˜ê±°ë‚˜ PRì´ ìƒì„±ë  ë•Œ ì‹¤í–‰
on:
  push:
    branches: [main, develop]
    paths:
      # ëª¨ë…¸ë ˆí¬: ë³€ê²½ëœ í”„ë¡œì íŠ¸ë§Œ CI ì‹¤í–‰
      - '#2 CS with AI - (2)/day15_todo-repository/**'
      - '#2 CS with AI - (3)/day17_upstage-network-lecture/**'
      - '#3 AI Product Engineering (3)/day31-40_medical-develop/**'
      - '#4 AI Backend Engineering (1)/day41-45_starter-code/**'
      # ì›Œí¬í”Œë¡œìš°ê°€ ë°”ë€Œë©´ CI ìžì²´ ê²€ì¦ì„ ìœ„í•´ ì‹¤í–‰
      - '.github/workflows/**'
      - '!**/*.md'
  pull_request:
    branches: [main]
    paths:
      - '#2 CS with AI - (2)/day15_todo-repository/**'
      - '#2 CS with AI - (3)/day17_upstage-network-lecture/**'
      - '#3 AI Product Engineering (3)/day31-40_medical-develop/**'
      - '#4 AI Backend Engineering (1)/day41-45_starter-code/**'
      - '.github/workflows/**'
      - '!**/*.md'
  # ì—¬ê¸°ì— ìž‘ì„±í•˜ì„¸ìš”!

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ëª¨ë…¸ë ˆí¬ í”„ë¡œì íŠ¸(í•˜ìœ„ ë””ë ‰í† ë¦¬) ê°ì§€
  detect-project:
    name: Detect Project Directory
    runs-on: ubuntu-latest
    outputs:
      project_dir: ${{ steps.pick.outputs.project_dir }}
      should_run: ${{ steps.pick.outputs.should_run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: pick
        shell: bash
        run: |
          set -euo pipefail

          # ë³€ê²½ íŒŒì¼ ëª©ë¡ ê³„ì‚°
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.event.pull_request.head.sha }}"
          else
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
          fi

          CHANGED="$(git diff --name-only "$BASE" "$HEAD" || true)"

          # ì›Œí¬í”Œë¡œìš°ë§Œ ë°”ë€ ê²½ìš°ì—ë„ CI ì‹¤í–‰ì€ í•„ìš”.
          # í•˜ì§€ë§Œ "ì–´ëŠ í”„ë¡œì íŠ¸ dirì—ì„œ ëŒë¦´ì§€"ëŠ” ê²°ì •í•´ì•¼ í•¨.
          # ì—¬ê¸°ì„œëŠ” ìš°ì„ ìˆœìœ„(1ê°œ)ë§Œ ì„ íƒ: ì²« ë§¤ì¹­ í”„ë¡œì íŠ¸.
          # ì—¬ëŸ¬ í”„ë¡œì íŠ¸ë¥¼ ë™ì‹œì— ë°”ê¾¸ëŠ” ì¼€ì´ìŠ¤ê¹Œì§€ ì»¤ë²„í•˜ë ¤ë©´ matrixë¡œ í™•ìž¥.
          PROJECT_DIR=""

          if echo "$CHANGED" | grep -qE "^#4 AI Backend Engineering \(1\)/day41-45_starter-code/"; then
            PROJECT_DIR="#4 AI Backend Engineering (1)/day41-45_starter-code"
          elif echo "$CHANGED" | grep -qE "^#3 AI Product Engineering \(3\)/day31-40_medical-develop/"; then
            PROJECT_DIR="#3 AI Product Engineering (3)/day31-40_medical-develop"
          elif echo "$CHANGED" | grep -qE "^#2 CS with AI - \(3\)/day17_upstage-network-lecture/"; then
            PROJECT_DIR="#2 CS with AI - (3)/day17_upstage-network-lecture"
          elif echo "$CHANGED" | grep -qE "^#2 CS with AI - \(2\)/day15_todo-repository/"; then
            PROJECT_DIR="#2 CS with AI - (2)/day15_todo-repository"
          elif echo "$CHANGED" | grep -qE "^\.github/workflows/"; then
            # ì›Œí¬í”Œë¡œìš°ë§Œ ë°”ë€ ê²½ìš°: ê¸°ë³¸ íƒ€ê¹ƒì„ day41ë¡œ ë‘  (ì‹¤ìŠµ ëŒ€ìƒ)
            PROJECT_DIR="#4 AI Backend Engineering (1)/day41-45_starter-code"
          fi

          if [ -z "$PROJECT_DIR" ]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "project_dir=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "project_dir=$PROJECT_DIR" >> "$GITHUB_OUTPUT"

  # TODO 2: lint job ìž‘ì„±
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: detect-project
    if: needs.detect-project.outputs.should_run == 'true'
    defaults:
      run:
        working-directory: ${{ needs.detect-project.outputs.project_dir }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run Ruff (lint)
        run: uv run ruff check app/ tests/ --output-format=github

      - name: Run Ruff (format)
        run: uv run ruff format app/ tests/ --check
      # ì—¬ê¸°ì— ìž‘ì„± í•˜ì„¸ìš”!

  # TODO 3: test job ìž‘ì„±
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-project, lint]
    if: needs.detect-project.outputs.should_run == 'true'
    defaults:
      run:
        working-directory: ${{ needs.detect-project.outputs.project_dir }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        env:
          UPSTAGE_API_KEY: ${{ secrets.UPSTAGE_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: uv run pytest tests/ -v --tb=short
    # ì—¬ê¸°ì— ìž‘ì„±í•˜ì„¸ìš”!


  # Job 3: Comment (PR ì½”ë©˜íŠ¸)
  comment:
    name: Report Status
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [lint, test]
    permissions:
      pull-requests: write
    steps:
      - name: Post Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
        run: |
          # ì´ëª¨ì§€ ì„¤ì •
          if [ "$LINT_RESULT" == "success" ]; then LINT_ICON="âœ…"; else LINT_ICON="âŒ"; fi
          if [ "$TEST_RESULT" == "success" ]; then TEST_ICON="âœ…"; else TEST_ICON="âŒ"; fi
          if [ "$TEST_RESULT" == "skipped" ]; then TEST_ICON="âšª"; fi

          # ì½”ë©˜íŠ¸ ë‚´ìš© ìž‘ì„±
          echo "### ðŸ›¡ï¸ Lumi Agent CI Report" > status_report.md
          echo "" >> status_report.md
          echo "| Category | Status |" >> status_report.md
          echo "|----------|--------|" >> status_report.md
          echo "| **Lint** | $LINT_ICON $LINT_RESULT |" >> status_report.md
          echo "| **Test** | $TEST_ICON $TEST_RESULT |" >> status_report.md
          echo "" >> status_report.md

          if [ "$LINT_RESULT" != "success" ] || [ "$TEST_RESULT" == "failure" ]; then
             echo "âš ï¸ **í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.** ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> status_report.md
             EXIT_CODE=1
          else
             echo "ðŸŽ‰ **ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!**" >> status_report.md
             EXIT_CODE=0
          fi

          # PR ì½”ë©˜íŠ¸ ì „ì†¡
          gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body-file status_report.md

          # ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš°ë„ ì‹¤íŒ¨ ì²˜ë¦¬
          exit $EXIT_CODE

  # Job 4: AI Code Review
  ai-review:
    name: AI Review
    runs-on: ubuntu-latest
    needs: [detect-project, lint]
    if: github.event_name == 'pull_request' && needs.detect-project.outputs.should_run == 'true'
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: ${{ needs.detect-project.outputs.project_dir }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run AI Reviewer
        env:
          UPSTAGE_API_KEY: ${{ secrets.UPSTAGE_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          REVIEW=$(uv run python scripts/ai_reviewer.py)

          # gh CLIë¡œ ì½”ë©˜íŠ¸ ë‹¬ê¸°
          echo "$REVIEW" > review_content.txt
          gh pr comment ${{ github.event.pull_request.number }} --body-file review_content.txt